# ============================================================
# Prometheus Configuration
# External Prometheus scraping k0s cluster (Helm-based)
# ============================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s

alerting:
  alertmanagers:
    - static_configs:
        - targets: []

scrape_configs:

  # ------------------------------------------------------------
  # Prometheus self
  # ------------------------------------------------------------
  - job_name: "prometheus"
    static_configs:
      - targets:
          - "localhost:{{ prometheus_port | default(9090) }}"


  # ------------------------------------------------------------
  # Node Exporter (Helm – EndpointSlice)
  # Namespace : monitoring
  # Service   : node-exporter-prometheus-node-exporter
  # Scrape via NodeIP:9100 (external Prometheus compatible)
  # ------------------------------------------------------------
  - job_name: "k0s-node-exporter"
    kubernetes_sd_configs:
      - role: endpointslice
        kubeconfig_file: /etc/prometheus/kubeconfig

    relabel_configs:
      # Keep only monitoring namespace
      - source_labels: [__meta_kubernetes_namespace]
        action: keep
        regex: monitoring

      # Match node-exporter service
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: node-exporter-prometheus-node-exporter

      # Attach node name label
      - source_labels: [__meta_kubernetes_node_name]
        target_label: node

      # Attach cluster label
      - target_label: cluster
        replacement: k0s


  # ------------------------------------------------------------
  # kube-state-metrics (External Prometheus – via NodeIP)
  # Namespace : monitoring
  # Service   : kube-state-metrics
  # Scrape    : NodeIP:8080
  # ------------------------------------------------------------
  - job_name: "k0s-kube-state-metrics"
    kubernetes_sd_configs:
      - role: endpoints
        kubeconfig_file: /etc/prometheus/kubeconfig

    relabel_configs:
      # Keep monitoring namespace
      - source_labels: [__meta_kubernetes_namespace]
        action: keep
        regex: monitoring

      # Match kube-state-metrics service
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: kube-state-metrics

      # Keep only node endpoints (not pod IP)
      - source_labels: [__meta_kubernetes_endpoint_address_target_kind]
        action: keep
        regex: Node

      # Use Node IP instead of Pod IP
      - source_labels: [__meta_kubernetes_endpoint_address]
        target_label: __address__
        replacement: $1:8080

      # Attach cluster label
      - target_label: cluster
        replacement: k0s


rule_files:
  - "/etc/prometheus/rules/*.yml"
