- name: Ensure netfilter-persistent is installed
  apt:
    name: netfilter-persistent
    state: present
    update_cache: yes

# ======================================================
# ===== FORWARD VPN → VPC ==============================
# Cho phép client VPN (10.8.0.0/24) đi vào VPC (10.20.0.0/16)
# ======================================================
- name: Allow VPN clients to access VPC
  iptables:
    table: filter
    chain: FORWARD
    in_interface: tun0
    out_interface: "{{ openvpn_private_iface }}"
    jump: ACCEPT
    state: present

# ======================================================
# ===== FORWARD VPC → VPN ==============================
# Cho phép traffic trả về từ VPC quay lại VPN client
# ======================================================
- name: Allow return traffic from VPC to VPN
  iptables:
    table: filter
    chain: FORWARD
    in_interface: "{{ openvpn_private_iface }}"
    out_interface: tun0
    jump: ACCEPT
    state: present

# ======================================================
# ===== NAT VPN CLIENTS ================================
# ⚠️ QUAN TRỌNG:
# KHÔNG SNAT VPN → VPC
# Giữ nguyên source IP = 10.8.0.x
#
# Lý do:
# - Security Group đang allow 10.8.0.0/24
# - SNAT sẽ đổi source thành IP private của OpenVPN EC2
# - Gây lỗi SSH / kubectl / EKS private endpoint
# ======================================================

# - name: NAT VPN traffic to VPC
#   iptables:
#     table: nat
#     chain: POSTROUTING
#     source: "{{ openvpn_network }}/24"
#     out_interface: "{{ openvpn_private_iface }}"
#     jump: MASQUERADE
#     state: present

# ======================================================
# ===== SAVE IPTABLES RULES ============================
# ======================================================
- name: Save iptables rules
  command: netfilter-persistent save
